<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8NEMWLX7BF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8NEMWLX7BF');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דשבורד גננות | המרכז המוזיקלי המאוחד</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --purim-color: #9c27b0; --morning-color: #ff9800; --movement-color: #4caf50;
            --birthday-color: #e91e63; --manual-color: #8e44ad; --classics-color: #2196f3;
            --relax-color: #607d8b; --story-color: #795548; --bg-color: #f4f7f6;
            --card-radius: 20px;
        }
        
        body { background-color: var(--bg-color); font-family: 'Assistant', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: #ffffff; box-shadow: 0 2px 15px rgba(0,0,0,0.03); padding: 1rem 0; }
        .dashboard-title { font-weight: 800; color: #2c3e50; font-size: 1.5rem; display: flex; align-items: center; gap: 8px; }
        .dashboard-title i { color: #e74c3c; }
        
        /* כפתור תפילות */
        .btn-prayers {
            background: #fff5f5;
            color: #d63031;
            border: 1.5px solid #fab1a0;
            padding: 6px 15px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-prayers:hover { background: #d63031; color: white; }

        .time-badge { background: #f8f9fa; border-radius: 12px; padding: 10px 15px; border: 1px solid #eef2f5; text-align: center; min-width: 180px; }
        #clock-time { color: #2c3e50; font-weight: 800; font-size: 1.3rem; line-height: 1.2; }
        .date-text { color: #7f8c8d; font-size: 0.85rem; font-weight: 600; margin-top: 2px; }
        #date-hebrew { color: #2980b9; font-weight: 700; font-size: 0.9rem; }

        .category-bar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.04); overflow-x: auto; white-space: nowrap; }
        .nav-btn { border: none; background: #f1f3f5; color: #555; padding: 10px 22px; margin: 0 6px; border-radius: 50px; font-weight: 700; transition: all 0.3s; cursor: pointer; }
        .nav-btn.active { background: #2c3e50; color: white; transform: scale(1.05); }
        
        .search-container { max-width: 600px; margin: 25px auto 10px; padding: 0 15px; position: relative; }
        .search-input { border-radius: 50px; padding: 12px 45px 12px 20px; border: 2px solid #e9ecef; width: 100%; text-align: right; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: #3498db; }

        .stream-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 20px 0; }
        .stream-grid.active { display: grid; }
        
        .video-card { background: white; border-radius: var(--card-radius); overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,0.04); transition: 0.3s; display: flex; flex-direction: column; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; background-color: #000; cursor: pointer; }
        .video-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .glass-play-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; transition: 0.3s; }
        .video-card:hover .glass-play-btn { background: rgba(231, 76, 60, 0.9); }
        .video-title { padding: 15px; font-weight: 700; font-size: 1rem; text-align: right; margin: 0; flex-grow: 1; }
        
        .lesson-btn-container { padding: 0 15px 15px; }
        .btn-lesson { width: 100%; border: none; background: #f1f4f8; padding: 10px; border-radius: 12px; font-size: 0.9rem; font-weight: 700; color: #34495e; transition: 0.2s; }
        .lesson-plan-box { display: none; padding: 15px; background: #f0f7fb; font-size: 0.95rem; border-top: 1px solid #e1eef6; border-radius: 0 0 20px 20px; }
        .lesson-plan-box.show { display: block; }
        
        /* עיצוב מודאל תפילות */
        .prayer-section { border-bottom: 2px solid #f1f1f1; padding-bottom: 20px; margin-bottom: 20px; }
        .prayer-section:last-child { border-bottom: none; }
        .prayer-title { color: #d63031; font-weight: 800; margin-bottom: 10px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .prayer-text { font-size: 1.15rem; line-height: 1.8; color: #2d3436; font-weight: 600; text-align: center; }

        footer { background: white; padding: 25px 0; margin-top: auto; text-align: center; border-top: 1px solid #eee; }
    </style>
</head>
<body>

<header>
    <div class="container d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
            <h1 class="dashboard-title m-0"><i class="bi bi-music-note-beamed"></i> המרכז המוזיקלי</h1>
            <button class="btn-prayers" data-bs-toggle="modal" data-bs-target="#prayersModal">
                <i class="bi bi-heart-fill"></i> תפילות
            </button>
        </div>
        <div class="time-badge">
            <div id="clock-time">--:--</div>
            <div id="date-hebrew" class="date-text">טוען תאריך...</div>
            <div id="date-gregorian" class="date-text"></div>
        </div>
    </div>
</header>

<div class="modal fade" id="prayersModal" tabindex="-1" aria-labelledby="prayersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius: 25px; border: none;">
      <div class="modal-header" style="border-bottom: none; padding: 20px 30px;">
        <h5 class="modal-title fw-bold" id="prayersModalLabel">תפילות בוקר ושלום</h5>
        <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 10px 30px 30px;">
        
        <div class="prayer-section">
            <div class="prayer-title"><i class="bi bi-sun-fill"></i> מודה אני</div>
            <div class="prayer-text">
                מוֹדֶה אֲנִי לְפָנֶיךָ מֶלֶךְ חַי וְקַיָּם,<br>
                שֶׁהֶחֱזַרְתָּ בִּי נִשְׁמָתִי בְּחֶמְלָה,<br>
                רַבָּה אֱמוּנָתֶךָ.
            </div>
        </div>

        <div class="prayer-section">
            <div class="prayer-title"><i class="bi bi-shield-shaded"></i> תפילה לשלום חיילי צה"ל</div>
            <div class="prayer-text" style="font-size: 1rem;">
                מִי שֶׁבֵּרַךְ אֲבוֹתֵינוּ אַבְרָהָם יִצְחָק וְיַעֲקֹב, הוּא יְבָרֵךְ אֶת חַיָּלֵי צְבָא הֲגַנָּה לְיִשְׂרָאֵל, הָעוֹמְדִים עַל מִשְׁמַר אַרְצֵנוּ וְעָרֵי אֱלֹהֵינוּ, מִגְּבוּל הַלְּבָנוֹן וְעַד מִדְבַּר מִצְרַיִם, וּמִן הַיָּם הַגָּדוֹל עַד לְבוֹא הָעֲרָבָה, בַּיַּבָּשָׁה בָּאֲוִיר וּבַיָּם.<br><br>
                יִתֵּן ה' אֶת אוֹיְבֵינוּ הַקָּמִים עָלֵינוּ נִגָּפִים לִפְנֵיהֶם! הַקָּדוֹשׁ בָּרוּךְ הוּא יִשְׁמֹר וְיַצִּיל אֶת חַיָּלֵינוּ מִכָּל צָרָה וְצוּקָה, וּמִכָּל נֶגַע וּמַחֲלָה, וְיִשְׁלַח בְּרָכָה וְהַצְלָחָה בְּכָל מַעֲשֵׂה יְדֵיהֶם. יַדְבֵּר שׂוֹנְאֵינוּ תַּחְתֵּיהֶם, וִיעַטְּרֵם בְּכֶתֶר יְשׁוּעָה וּבְעֲטֶרֶת נִצָּחוֹן. וִיקֻיַּם בָּהֶם הַכָּתוּב: "כִּי ה' אֱלֹהֵיכֶם הַהֹלֵךְ עִמָּכֶם, לְהִלָּחֵם לָכֶם עִם אֹיְבֵיכֶם לְהוֹשִׁיעַ אֶתְכֶם". וְנֹאמַר: אָמֵן.
            </div>
        </div>

      </div>
    </div>
  </div>
</div>

<nav class="category-bar">
    <div class="container d-flex">
        <button class="nav-btn btn-manual active" onclick="switchCat('manual_section', this)"><i class="bi bi-star-fill"></i> המבחר שלי</button>
        <button class="nav-btn" onclick="switchCat('birthday', this)"><i class="bi bi-cake2-fill"></i> יום הולדת</button>
        <button class="nav-btn" onclick="switchCat('purim', this)"><i class="bi bi-mask"></i> פורים</button>
        <button class="nav-btn" onclick="switchCat('morning_circle', this)"><i class="bi bi-brightness-high-fill"></i> מפגש בוקר</button>
        <button class="nav-btn" onclick="switchCat('movement_play', this)"><i class="bi bi-person-walking"></i> תנועה</button>
        <button class="nav-btn" onclick="switchCat('israeli_classics', this)"><i class="bi bi-boombox-fill"></i> קלאסיקות</button>
        <button class="nav-btn" onclick="switchCat('relaxation_sleep', this)"><i class="bi bi-moon-stars-fill"></i> מנוחה</button>
        <button class="nav-btn" onclick="switchCat('story_time', this)"><i class="bi bi-book-half"></i> שעת סיפור</button>
    </div>
</nav>

<div class="search-container">
    <input type="text" id="songSearch" class="search-input" placeholder="חפשי שיר או הפעלה..." onkeyup="filterSongs()">
</div>

<main class="container py-4 flex-grow-1">
    <div id="manual_section" class="stream-grid active"></div>
    <div id="birthday" class="stream-grid"></div>
    <div id="purim" class="stream-grid"></div>
    <div id="morning_circle" class="stream-grid"></div>
    <div id="movement_play" class="stream-grid"></div>
    <div id="israeli_classics" class="stream-grid"></div>
    <div id="relaxation_sleep" class="stream-grid"></div>
    <div id="story_time" class="stream-grid"></div>
</main>

<footer>
    <p class="m-0 text-muted fw-bold">נבנה באהבה לגננות ישראל &copy; 2026 | Almog787</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentCategory = 'manual_section';

    function getGematria(num) {
        if (num <= 0) return '';
        let str = '';
        const letters = { 
            400: 'ת', 300: 'ש', 200: 'ר', 100: 'ק', 90: 'צ', 80: 'פ', 70: 'ע', 60: 'ס', 50: 'נ', 40: 'מ', 30: 'ל', 20: 'כ', 10: 'י', 9: 'ט', 8: 'ח', 7: 'ז', 6: 'ו', 5: 'ה', 4: 'ד', 3: 'ג', 2: 'ב', 1: 'א' 
        };
        const keys = Object.keys(letters).sort((a, b) => b - a);
        let n = num;
        if (n >= 5000) n -= 5000;
        for (let key of keys) {
            while (n >= key) {
                if (n === 15) { str += 'טו'; n = 0; break; }
                if (n === 16) { str += 'טז'; n = 0; break; }
                str += letters[key];
                n -= key;
            }
        }
        if (str.length === 1) return str + "'";
        return str.slice(0, -1) + '"' + str.slice(-1);
    }

    function updateDateTime() {
        const now = new Date();
        document.getElementById('clock-time').innerText = now.toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('date-gregorian').innerText = now.toLocaleDateString('he-IL', {day:'numeric', month:'long', year:'numeric'});
        try {
            const options = { day: 'numeric', month: 'long', year: 'numeric', calendar: 'hebrew' };
            const heParts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', options).formatToParts(now);
            const dayNum = parseInt(heParts.find(p => p.type === 'day').value);
            const monthName = heParts.find(p => p.type === 'month').value;
            const yearNum = parseInt(heParts.find(p => p.type === 'year').value);
            document.getElementById('date-hebrew').innerText = `${getGematria(dayNum)} ב${monthName} ה'${getGematria(yearNum)}`;
        } catch(e) { console.error(e); }
    }

    function toggleLesson(btn, title) {
        const box = btn.parentElement.nextElementSibling;
        box.classList.toggle('show');
        btn.innerHTML = box.classList.contains('show') ? '<i class="bi bi-chevron-up"></i> סגור' : '<i class="bi bi-lightbulb"></i> רעיון לפעילות';
    }

    function switchCat(id, btn) {
        currentCategory = id;
        document.querySelectorAll('.stream-grid').forEach(g => g.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function filterSongs() {
        const query = document.getElementById('songSearch').value.toLowerCase();
        const activeGrid = document.querySelector('.stream-grid.active');
        activeGrid.querySelectorAll('.video-card').forEach(card => {
            const title = card.querySelector('.video-title').innerText.toLowerCase();
            card.style.display = title.includes(query) ? "flex" : "none";
        });
    }

    function getYouTubeID(song) {
        if (song.id && song.id.length === 11) return song.id;
        const match = song.url?.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : '';
    }

    function loadVideo(container, idOrUrl, title) {
        const id = getYouTubeID({url: idOrUrl, id: idOrUrl});
        if(id) {
            container.innerHTML = `<iframe src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;border-radius:20px 20px 0 0;"></iframe>`;
        }
    }

    async function initDashboard() {
        try {
            const [resAuto, resManual] = await Promise.all([
                fetch(`streams.json?v=${Date.now()}`).then(r => r.json()).catch(() => ({})),
                fetch(`manual_links.json?v=${Date.now()}`).then(r => r.json()).catch(() => ({}))
            ]);
            
            const allKeys = new Set([...Object.keys(resAuto), ...Object.keys(resManual)]);
            allKeys.forEach(key => {
                const grid = document.getElementById(key);
                if (!grid) return;
                const songs = [...(resManual[key] || []), ...(resAuto[key] || [])];
                grid.innerHTML = songs.map(song => `
                    <article class="video-card">
                        <div class="video-container" onclick="loadVideo(this, '${song.url || song.id}', '${song.title.replace(/'/g, "\\'")}')">
                            <img src="https://img.youtube.com/vi/${getYouTubeID(song)}/hqdefault.jpg">
                            <div class="glass-play-btn"><i class="bi bi-play-fill"></i></div>
                        </div>
                        <h3 class="video-title">${song.title}</h3>
                        ${song.lesson_plan ? `
                            <div class="lesson-btn-container">
                                <button class="btn-lesson" onclick="toggleLesson(this, '${song.title.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-lightbulb"></i> רעיון לפעילות
                                </button>
                            </div>
                            <div class="lesson-plan-box">${song.lesson_plan}</div>
                        ` : ''}
                    </article>
                `).join('');
            });
        } catch (e) { console.error(e); }
    }

    setInterval(updateDateTime, 1000);
    updateDateTime();
    initDashboard();
</script>
</body>
</html>
